name: Tag On Push to Main

on:
  push:
    branches: [main]

permissions:
  contents: write
  actions: write

concurrency:
  group: tag-on-pr-merge-main
  cancel-in-progress: false

jobs:
  tag:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Configure git identity for tagging
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create and push next semver tag
        id: create_tag
        env:
          MERGE_SHA: ${{ github.sha }}
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
          PR_TITLE: ${{ github.event.pull_request.title || 'Direct push to main' }}
        run: |
          set -euo pipefail

          if [[ -z "${MERGE_SHA}" ]]; then
            echo "No commit SHA found; skipping tag creation."
            exit 0
          fi

          git fetch --tags --force

          existing_tag="$(git tag --points-at "${MERGE_SHA}" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1 || true)"
          if [[ -n "${existing_tag}" ]]; then
            echo "Commit already has semver tag: ${existing_tag}"
            echo "release_tag=${existing_tag}" >> "${GITHUB_OUTPUT}"
            echo "tag_created=false" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          attempt=1
          max_attempts=5
          while [[ ${attempt} -le ${max_attempts} ]]; do
            latest_tag="$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1 || true)"

            if [[ -z "${latest_tag}" ]]; then
              next_tag="v0.1.0"
            else
              if [[ "${latest_tag}" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
                major="${BASH_REMATCH[1]}"
                minor="${BASH_REMATCH[2]}"
                patch="${BASH_REMATCH[3]}"
                next_tag="v${major}.${minor}.$((patch + 1))"
              else
                echo "Latest tag is not strict semver: ${latest_tag}"
                exit 1
              fi
            fi

            if git rev-parse "${next_tag}" >/dev/null 2>&1; then
              echo "Tag ${next_tag} already exists locally/remotely, retrying..."
              git fetch --tags --force
              attempt=$((attempt + 1))
              sleep 1
              continue
            fi

            if [[ -n "${PR_NUMBER}" ]]; then
              git tag -a "${next_tag}" "${MERGE_SHA}" -m "Release ${next_tag} from merged PR #${PR_NUMBER}: ${PR_TITLE}"
            else
              git tag -a "${next_tag}" "${MERGE_SHA}" -m "Release ${next_tag}: ${PR_TITLE}"
            fi
            if git push origin "${next_tag}"; then
              echo "Created and pushed ${next_tag}"
              echo "release_tag=${next_tag}" >> "${GITHUB_OUTPUT}"
              echo "tag_created=true" >> "${GITHUB_OUTPUT}"
              exit 0
            fi

            echo "Push failed for ${next_tag}, retrying..."
            git tag -d "${next_tag}" || true
            git fetch --tags --force
            attempt=$((attempt + 1))
            sleep 1
          done

          echo "Failed to create unique semver tag after ${max_attempts} attempts"
          exit 1

      - name: Create GitHub Release
        if: steps.create_tag.outputs.tag_created == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.release_tag }}
          name: ${{ steps.create_tag.outputs.release_tag }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
