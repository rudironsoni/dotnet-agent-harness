# Complex Object Comparison and Custom Assertions Extensions

> This document is extracted from [SKILL.md](../SKILL.md) and covers complete examples of deep object comparison and custom assertion extensions.

---

## Deep Object Comparison

### Complete Object Comparison

```csharp
[Fact]
public void ComplexObject_DeepComparison_ShouldWork()
{
    var expected = new Order
    {
        Id = 1,
        CustomerName = "John Doe",
        Items = new[]
        {
            new OrderItem { ProductId = 1, Quantity = 2, Price = 10.5m },
            new OrderItem { ProductId = 2, Quantity = 1, Price = 25.0m }
        },
        TotalAmount = 46.0m,
        CreatedAt = DateTime.Now
    };
    
    var actual = orderService.CreateOrder(orderRequest);
    
    // Deep object comparison
    actual.Should().BeEquivalentTo(expected);
}
```

### Excluding Specific Properties

```csharp
[Fact]
public void ComplexObject_ExcludeProperties_ShouldWork()
{
    var user = userService.CreateUser("john@example.com");
    
    user.Should().BeEquivalentTo(new
    {
        Email = "john@example.com",
        IsActive = true
    }, options => options
        .Excluding(u => u.Id)           // Exclude auto-generated ID
        .Excluding(u => u.CreatedAt)    // Exclude timestamps
        .Excluding(u => u.UpdatedAt)
    );
}
```

### Dynamic Field Exclusion

```csharp
[Fact]
public void ComplexObject_DynamicExclusion_ShouldWork()
{
    var entity = entityService.CreateEntity(data);
    
    // Use pattern to exclude all time-related fields
    entity.Should().BeEquivalentTo(expectedEntity, options => options
        .Excluding(ctx => ctx.Path.EndsWith("At"))
        .Excluding(ctx => ctx.Path.EndsWith("Time"))
        .Excluding(ctx => ctx.Path.Contains("Timestamp"))
    );
}
```

### Circular Reference Handling

```csharp
[Fact]
public void ComplexObject_CircularReference_ShouldWork()
{
    var parent = new TreeNode { Value = "Root" };
    var child = new TreeNode { Value = "Child", Parent = parent };
    parent.Children = new[] { child };
    
    var actualTree = treeService.GetTree("Root");
    
    // Handle circular references
    actualTree.Should().BeEquivalentTo(parent, options => options
        .IgnoringCyclicReferences()
        .WithMaxRecursionDepth(10)
    );
}
```

---

## Custom Assertions Extensions

### Domain-Specific Assertions

Create project-specific assertion methods to improve test readability and maintainability.

#### Example: E-Commerce Domain Assertions

Refer to [../templates/custom-assertions-template.cs](../templates/custom-assertions-template.cs) for complete implementation.

```csharp
public static class ECommerceAssertions
{
    public static AndConstraint<ObjectAssertions> BeValidProduct(
        this ObjectAssertions assertions)
    {
        var product = assertions.Subject as Product;
        
        product.Should().NotBeNull();
        product!.Id.Should().BeGreaterThan(0);
        product.Name.Should().NotBeNullOrEmpty();
        product.Price.Should().BeGreaterThan(0);
        
        return new AndConstraint<ObjectAssertions>(assertions);
    }
    
    public static AndConstraint<ObjectAssertions> BeValidOrder(
        this ObjectAssertions assertions)
    {
        var order = assertions.Subject as Order;
        
        order.Should().NotBeNull();
        order!.Items.Should().NotBeNullOrEmpty();
        order.TotalAmount.Should().BeGreaterThan(0);
        
        return new AndConstraint<ObjectAssertions>(assertions);
    }
}
```

#### Using Custom Assertions

```csharp
[Fact]
public void Product_CreateProduct_ShouldBeValidProduct()
{
    var product = productService.Create("Laptop", 999.99m);
    
    // Use domain-specific assertions
    product.Should().BeValidProduct();
    product.Name.Should().Be("Laptop");
}
```

### Reusable Exclusion Extensions

```csharp
public static class SmartExclusionExtensions
{
    public static EquivalencyOptions<T> ExcludingAutoGeneratedFields<T>(
        this EquivalencyOptions<T> options)
    {
        return options
            .Excluding(ctx => ctx.Path.EndsWith("Id") && 
                            ctx.SelectedMemberInfo.Name.StartsWith("Generated"))
            .Excluding(ctx => ctx.Path.EndsWith("At"))
            .Excluding(ctx => ctx.Path.Contains("Version"))
            .Excluding(ctx => ctx.Path.Contains("Timestamp"));
    }
    
    public static EquivalencyOptions<T> ExcludingAuditFields<T>(
        this EquivalencyOptions<T> options)
    {
        return options
            .Excluding(ctx => ctx.Path.Contains("CreatedBy"))
            .Excluding(ctx => ctx.Path.Contains("CreatedAt"))
            .Excluding(ctx => ctx.Path.Contains("ModifiedBy"))
            .Excluding(ctx => ctx.Path.Contains("ModifiedAt"));
    }
}
```

Usage Example:

```csharp
[Fact]
public void Entity_Comparison_ShouldUseSmartExclusion()
{
    var user = userService.CreateUser("test@example.com");
    var retrieved = userService.GetUser(user.Id);
    
    retrieved.Should().BeEquivalentTo(user, options => options
        .ExcludingAutoGeneratedFields()
        .ExcludingAuditFields()
    );
}
```
